# üîî WebSocket Real-Time –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –ü–æ–ª–Ω–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 22.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–í–µ—Ä—Å–∏—è:** 1.0.0

---

## üìã –û–ë–ó–û–†

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–ø–æ–ª–Ω–∞—è end-to-end —Å–∏—Å—Ç–µ–º–∞ real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** —á–µ—Ä–µ–∑ WebSocket –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–ª—å—é.

### ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   - –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–æ–ø–∏–∫–∞–º
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –∏ —Ä–æ–ª–µ–π

2. **WebSocket –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
   - –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ endpoints –∏ —Ç–æ–ø–∏–∫–∏
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ broadcast –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å legacy —Ç–æ–ø–∏–∫–∞–º–∏

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ –º–æ–¥—É–ª—è–º–∏**
   - Pain Escalation —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - EMR –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
   - –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

4. **–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**
   - REST API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ WebSocket
   - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
websocket/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ UnifiedNotificationDTO.java          # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π DTO –¥–ª—è –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îî‚îÄ‚îÄ UnifiedNotificationService.java      # –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îî‚îÄ‚îÄ controller/
    ‚îî‚îÄ‚îÄ WebSocketTestController.java         # REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

external_emr_integration_service/config/
‚îî‚îÄ‚îÄ WebSocketConfig.java                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WebSocket (–æ–±–Ω–æ–≤–ª–µ–Ω–∞)

pain_escalation_tracking/service/
‚îî‚îÄ‚îÄ PainEscalationNotificationService.java   # –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º
```

---

## üîå WEBSOCKET ENDPOINTS

### –û—Å–Ω–æ–≤–Ω—ã–µ endpoints:

1. **`ws://localhost:8080/ws-notifications`** - –æ—Å–Ω–æ–≤–Ω–æ–π endpoint –¥–ª—è –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. **`ws://localhost:8080/ws-emr-alerts`** - legacy endpoint (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

---

## üì° –î–û–°–¢–£–ü–ù–´–ï –¢–û–ü–ò–ö–ò

### 1. –û–±—â–∏–µ —Ç–æ–ø–∏–∫–∏

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –ö—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è |
|-------|----------|-------------------|
| `/topic/notifications/all` | –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | Dashboard, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã |
| `/topic/notifications/critical` | –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | –í—Å–µ —Ä–æ–ª–∏ |

### 2. –¢–æ–ø–∏–∫–∏ –ø–æ —Ä–æ–ª—è–º

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –ö—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è |
|-------|----------|-------------------|
| `/topic/notifications/doctors` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤—Ä–∞—á–µ–π | –í—Ä–∞—á–∏ |
| `/topic/notifications/anesthesiologists` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–µ—Å—Ç–µ–∑–∏–æ–ª–æ–≥–æ–≤ | –ê–Ω–µ—Å—Ç–µ–∑–∏–æ–ª–æ–≥–∏ |
| `/topic/notifications/nurses` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –º–µ–¥—Å–µ—Å—Ç–µ—Ä | –ú–µ–¥—Å–µ—Å—Ç—Ä—ã |
| `/topic/notifications/admins` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã |

### 3. –¢–æ–ø–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è |
|-------|----------|-------------|
| `/topic/notifications/emr-alerts` | EMR –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã | EMR_ALERT |
| `/topic/notifications/pain-escalations` | –≠—Å–∫–∞–ª–∞—Ü–∏–∏ –±–æ–ª–∏ | PAIN_ESCALATION |
| `/topic/notifications/recommendations` | –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | RECOMMENDATION_UPDATE |
| `/topic/notifications/dose-reminders` | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–æ–∑–∞—Ö | DOSE_REMINDER |
| `/topic/notifications/protocol-approvals` | –û–¥–æ–±—Ä–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ | PROTOCOL_APPROVAL |
| `/topic/notifications/critical-vas` | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π VAS | CRITICAL_VAS |

### 4. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–æ–ø–∏–∫–∏

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `/queue/notifications/{userId}` | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |

### 5. Legacy —Ç–æ–ø–∏–∫–∏ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `/topic/escalations/doctors` | –≠—Å–∫–∞–ª–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–µ–π (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |
| `/topic/escalations/anesthesiologists` | –≠—Å–∫–∞–ª–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–µ—Å—Ç–µ–∑–∏–æ–ª–æ–≥–æ–≤ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |
| `/topic/escalations/dashboard` | Dashboard —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |
| `/topic/escalations/critical` | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |
| `/topic/escalations/status-updates` | –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |
| `/topic/emr-alerts` | EMR –∞–ª–µ—Ä—Ç—ã (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) |

---

## üì¶ –§–û–†–ú–ê–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø

### UnifiedNotificationDTO

```json
{
  "type": "PAIN_ESCALATION",
  "priority": "CRITICAL",
  "patientMrn": "EMR-12345",
  "patientName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "title": "–≠—Å–∫–∞–ª–∞—Ü–∏—è –±–æ–ª–∏: CRITICAL",
  "message": "VAS –∏–∑–º–µ–Ω–∏–ª—Å—è —Å 5 –Ω–∞ 9 (+4). Critical pain level: VAS 9",
  "details": "–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—Å—Ç –±–æ–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–æ–∑—ã",
  "recommendations": "URGENT: Immediate intervention required",
  "timestamp": "2025-10-22T20:00:00",
  "relatedEntityId": 123,
  "relatedEntityType": "ESCALATION",
  "additionalData": null,
  "requiresAction": true,
  "actionUrl": "/escalations/123",
  "diagnoses": ["M54.5 - Low back pain"],
  "targetRole": "DOCTOR",
  "targetUserId": null
}
```

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (NotificationType)

- **EMR_ALERT** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ EMR
- **PAIN_ESCALATION** - –≠—Å–∫–∞–ª–∞—Ü–∏—è –±–æ–ª–∏
- **RECOMMENDATION_UPDATE** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- **DOSE_REMINDER** - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–∑–µ
- **SYSTEM_MESSAGE** - –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **PROTOCOL_APPROVAL** - –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- **PATIENT_ADMISSION** - –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
- **CRITICAL_VAS** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –±–æ–ª–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (NotificationPriority)

- **LOW** - –ù–∏–∑–∫–∏–π (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ)
- **MEDIUM** - –°—Ä–µ–¥–Ω–∏–π (—Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è)
- **HIGH** - –í—ã—Å–æ–∫–∏–π (—Ç—Ä–µ–±—É–µ—Ç —Å–∫–æ—Ä–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è)
- **CRITICAL** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (—Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è)

---

## üíª –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê (JavaScript)

### –ë–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```javascript
// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
const socket = new SockJS('http://localhost:8080/ws-notifications');
const stompClient = Stomp.over(socket);

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
stompClient.connect({}, function(frame) {
    console.log('Connected: ' + frame);
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    stompClient.subscribe('/topic/notifications/all', function(message) {
        const notification = JSON.parse(message.body);
        handleNotification(notification);
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function handleNotification(notification) {
    console.log('Received notification:', notification);
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ UI
    showToast(notification.title, notification.message, notification.priority);
    
    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ - –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É
    if (notification.requiresAction) {
        showActionButton(notification.actionUrl);
    }
}
```

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–ø–∏–∫–æ–≤

```javascript
stompClient.connect({}, function(frame) {
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤—Ä–∞—á–µ–π
    stompClient.subscribe('/topic/notifications/doctors', function(message) {
        const notification = JSON.parse(message.body);
        handleDoctorNotification(notification);
    });
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    stompClient.subscribe('/topic/notifications/critical', function(message) {
        const notification = JSON.parse(message.body);
        handleCriticalNotification(notification);
    });
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –±–æ–ª–∏
    stompClient.subscribe('/topic/notifications/pain-escalations', function(message) {
        const notification = JSON.parse(message.body);
        handlePainEscalation(notification);
    });
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ EMR –∞–ª–µ—Ä—Ç—ã
    stompClient.subscribe('/topic/notifications/emr-alerts', function(message) {
        const notification = JSON.parse(message.body);
        handleEmrAlert(notification);
    });
});
```

### –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```javascript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
const userId = getCurrentUserId(); // –ü–æ–ª—É—á–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

stompClient.subscribe('/queue/notifications/' + userId, function(message) {
    const notification = JSON.parse(message.body);
    handlePersonalNotification(notification);
});
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

```javascript
stompClient.subscribe('/topic/notifications/all', function(message) {
    const notification = JSON.parse(message.body);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    switch(notification.priority) {
        case 'CRITICAL':
            showCriticalAlert(notification);
            playAlertSound();
            break;
        case 'HIGH':
            showHighPriorityNotification(notification);
            break;
        case 'MEDIUM':
            showMediumPriorityNotification(notification);
            break;
        case 'LOW':
            showLowPriorityNotification(notification);
            break;
    }
});
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### REST API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

```bash
curl -X POST http://localhost:8080/api/websocket/test
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "success",
  "message": "Test notification sent to all subscribers",
  "timestamp": "2025-10-22T20:00:00"
}
```

#### 2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π EMR –∞–ª–µ—Ä—Ç

```bash
curl -X POST http://localhost:8080/api/websocket/test/emr-alert
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π EMR –∞–ª–µ—Ä—Ç –Ω–∞ –≤—Å–µ —Ç–æ–ø–∏–∫–∏

#### 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —ç—Å–∫–∞–ª–∞—Ü–∏—é –±–æ–ª–∏

```bash
curl -X POST http://localhost:8080/api/websocket/test/pain-escalation
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –±–æ–ª–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º HIGH

#### 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

```bash
curl -X POST http://localhost:8080/api/websocket/test/critical
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ–ø–∏–∫–∏

#### 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

```bash
curl -X POST http://localhost:8080/api/websocket/test/personal/doctor_123
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `doctor_123`

#### 6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —Ä–æ–ª–∏

```bash
curl -X POST http://localhost:8080/api/websocket/test/role/DOCTOR
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º –≤—Ä–∞—á–∞–º

#### 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å WebSocket

```bash
curl http://localhost:8080/api/websocket/status
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "active",
  "endpoints": {
    "main": "ws://localhost:8080/ws-notifications",
    "legacy": "ws://localhost:8080/ws-emr-alerts"
  },
  "topics": {
    "all": "/topic/notifications/all",
    "doctors": "/topic/notifications/doctors",
    "anesthesiologists": "/topic/notifications/anesthesiologists",
    "nurses": "/topic/notifications/nurses",
    "critical": "/topic/notifications/critical",
    "emr_alerts": "/topic/notifications/emr-alerts",
    "pain_escalations": "/topic/notifications/pain-escalations"
  },
  "timestamp": "2025-10-22T20:00:00"
}
```

---

## üîó –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ú–û–î–£–õ–Ø–ú–ò

### 1. Pain Escalation Module

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –±–æ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```java
// –í PainEscalationServiceImpl.handleNewVasRecord()
Escalation savedEscalation = escalationRepository.save(escalation);

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
notificationService.sendEscalationNotification(
    savedEscalation,
    patient,
    newVasLevel,
    previousVasLevel,
    checkResult.getRecommendations()
);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/pain-escalations`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/doctors`
- –ï—Å–ª–∏ CRITICAL - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/critical`
- Legacy —Ñ–æ—Ä–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–µ —Ç–æ–ø–∏–∫–∏

### 2. EMR Change Detection

–ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö EMR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```java
// –í EmrRecalculationService.handleCriticalEmrChanges()
UnifiedNotificationDTO notification = UnifiedNotificationDTO.builder()
    .type(UnifiedNotificationDTO.NotificationType.EMR_ALERT)
    .priority(UnifiedNotificationDTO.NotificationPriority.CRITICAL)
    .patientMrn(patient.getMrn())
    .title("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ EMR: " + alert.getParameterName())
    .message(String.format("%s –∏–∑–º–µ–Ω–∏–ª—Å—è —Å %s –Ω–∞ %s",
            alert.getParameterName(),
            alert.getOldValue(),
            alert.getNewValue()))
    .build();

unifiedNotificationService.sendCriticalNotification(notification);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/emr-alerts`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/critical`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/topic/notifications/doctors`

### 3. Recommendation Updates

–ü—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```java
// –í EmrRecalculationService.sendNewRecommendationNotification()
UnifiedNotificationDTO notification = UnifiedNotificationDTO.builder()
    .type(UnifiedNotificationDTO.NotificationType.RECOMMENDATION_UPDATE)
    .priority(UnifiedNotificationDTO.NotificationPriority.HIGH)
    .title("–ù–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è EMR")
    .message("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π EMR")
    .build();

unifiedNotificationService.sendNotification(notification);
```

---

## üìä –ü–†–ò–ú–ï–†–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô

### –ü—Ä–∏–º–µ—Ä 1: –≠—Å–∫–∞–ª–∞—Ü–∏—è –±–æ–ª–∏

```json
{
  "type": "PAIN_ESCALATION",
  "priority": "HIGH",
  "patientMrn": "EMR-12345",
  "patientName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "title": "–≠—Å–∫–∞–ª–∞—Ü–∏—è –±–æ–ª–∏: HIGH",
  "message": "VAS –∏–∑–º–µ–Ω–∏–ª—Å—è —Å 5 –Ω–∞ 8 (+3). Pain increased significantly",
  "details": "–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—Å—Ç –±–æ–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –≤–≤–µ–¥–µ–Ω–∏—è –¥–æ–∑—ã",
  "recommendations": "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ–∑–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Å–º–µ–Ω—É –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞",
  "timestamp": "2025-10-22T15:30:00",
  "relatedEntityId": 456,
  "relatedEntityType": "ESCALATION",
  "requiresAction": true,
  "actionUrl": "/escalations/456",
  "diagnoses": ["M54.5 - Low back pain"],
  "targetRole": "DOCTOR"
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π EMR –∞–ª–µ—Ä—Ç

```json
{
  "type": "EMR_ALERT",
  "priority": "CRITICAL",
  "patientMrn": "EMR-12345",
  "patientName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "title": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ EMR: GFR",
  "message": "GFR –∏–∑–º–µ–Ω–∏–ª—Å—è —Å 45 –Ω–∞ 25",
  "details": "–¢—è–∂–µ–ª–∞—è –ø–æ—á–µ—á–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å. GFR < 30",
  "recommendations": "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π",
  "timestamp": "2025-10-22T16:00:00",
  "requiresAction": true,
  "targetRole": "DOCTOR"
}
```

### –ü—Ä–∏–º–µ—Ä 3: –ù–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

```json
{
  "type": "RECOMMENDATION_UPDATE",
  "priority": "HIGH",
  "patientMrn": "EMR-12345",
  "patientName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "title": "–ù–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è EMR",
  "message": "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è #789 –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π EMR",
  "details": "–ò–∑–º–µ–Ω–µ–Ω–∏—è EMR: GFR: 45 ‚Üí 25",
  "recommendations": "Tramadol 50mg PO q6h PRN (—Å–Ω–∏–∂–µ–Ω–æ –∏–∑-–∑–∞ GFR < 30)",
  "timestamp": "2025-10-22T16:05:00",
  "relatedEntityId": 789,
  "relatedEntityType": "RECOMMENDATION",
  "requiresAction": true,
  "actionUrl": "/recommendations/789",
  "targetRole": "DOCTOR"
}
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

- [x] UnifiedNotificationDTO —Å–æ–∑–¥–∞–Ω
- [x] UnifiedNotificationService —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] WebSocketConfig –æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º–∏ —Ç–æ–ø–∏–∫–∞–º–∏
- [x] WebSocketTestController —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] PainEscalationNotificationService –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [x] EmrRecalculationService –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π
- [x] –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] Broadcast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] Legacy —Ç–æ–ø–∏–∫–∏ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- [x] REST API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üöÄ –ó–ê–ü–£–°–ö –ò –ü–†–û–í–ï–†–ö–ê

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
mvn spring-boot:run
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å WebSocket

```bash
curl http://localhost:8080/api/websocket/status
```

### 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

```bash
curl -X POST http://localhost:8080/api/websocket/test
```

### 4. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞

–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```javascript
const socket = new SockJS('http://localhost:8080/ws-notifications');
const stompClient = Stomp.over(socket);

stompClient.connect({}, function(frame) {
    console.log('Connected!');
    
    stompClient.subscribe('/topic/notifications/all', function(message) {
        console.log('Received:', JSON.parse(message.body));
    });
});
```

### 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–ª–µ—Ä—Ç

```bash
curl -X POST http://localhost:8080/api/websocket/test/emr-alert
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞!

---

## üìö –°–í–Ø–ó–ê–ù–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- [Pain Escalation Module](PAIN_ESCALATION_MODULE.md)
- [EMR Recalculation](EMR_RECALCULATION.md)
- [WebSocket Configuration](../src/main/java/pain_helper_back/external_emr_integration_service/config/WebSocketConfig.java)

---

**–ê–≤—Ç–æ—Ä:** Pain Management Team  
**–î–∞—Ç–∞:** 22.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
